---
title: "Ames Housing: í—ˆìœ„ë§¤ë¬¼ íƒì§€ í”„ë¡œì íŠ¸"
author: 'ì¼ë‹¨ì¡1ì¡°(ì†¡ì„±í•„, í™ì£¼í˜•, í¸ì„œì˜, ì–‘í˜„ì¤€)'
format: 
  dashboard:
    theme: sandstone
    scrolling: True
    logo: imagebox/nofakehouse.png
    freeze: true
---


```{python}
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LassoCV
from sklearn.model_selection import train_test_split
import plotly.express as px

plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False
pd.set_option('display.max_columns', None)

######## ì „ì²˜ë¦¬ ê³¼ì • ########
# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
ames = pd.read_csv('ames.csv')
df = ames.copy()

# ê·¸ë£¹ ë¶„ë¥˜ 
df_ns = df.groupby('Neighborhood')['SalePrice'].mean()

# ë¶„ìœ„ìˆ˜ ê³„ì‚°
q1 = df_ns.quantile(0.25)
q2 = df_ns.quantile(0.75)

#df['price_level'] ì´ë¼ëŠ” ì¹¼ëŸ¼ìœ¼ë¡œ ì§‘ê°’ ë³„ ë¶„ìœ„ë¡œ êµ¬ë¶„
df['price_level'] = np.select(
    [
        df['Neighborhood'].isin(df_ns[df_ns <= q1].index),
        df['Neighborhood'].isin(df_ns[(df_ns > q1) & (df_ns <= q2)].index),
        df['Neighborhood'].isin(df_ns[df_ns > q2].index)
    ],
    ['Low', 'Mid', 'High'],
    default='Unknown'  #  ë¬¸ìì—´ë¡œ í†µì¼
)

# ë²”ì£¼í˜• ì»¬ëŸ¼ë§Œ ì„ íƒ
cat_cols = df.select_dtypes(include='object').columns
# ë²”ì£¼í˜• ê²°ì¸¡ì¹˜ 'None'ìœ¼ë¡œ ëŒ€ì²´
df[cat_cols] = df[cat_cols].fillna('None')


df['amenities'] = (
    (df['PoolArea'] > 0).astype(int) +
    (df['TotalBsmtSF'] > 0).astype(int) +
    (df['GarageArea'] > 0).astype(int) + 
    (df['MiscVal'] > 0).astype(int)
)

df['TotalRooms'] = df['TotRmsAbvGrd'] + df['HalfBath'] + df['FullBath']  # ìš•ì‹¤ ì œì™¸ ë°©ìˆ˜ + ë°˜ìš•ì‹¤ + í’€ìš•ì‹¤
df['RoomDensity'] = df['TotalRooms'] / df['GrLivArea']  # ë°© ë°€ë„ (ë°©ìˆ˜ / ê±°ì‹¤ ë©´ì )
##### í—ˆìœ„ë§¤ë¬¼ íŒë‹¨ #####


## ì¡°ê±´ : ê¸°ì¤€ê°’ ìƒìœ„ 25% ì´ìƒ
df['GrLivArea_th']    = df.groupby('price_level')['GrLivArea']   \
                           .transform(lambda x: x.quantile(0.75))
df['YearRemodAdd_th'] = df.groupby('price_level')['YearRemodAdd']\
                           .transform(lambda x: x.quantile(0.75))
df['RoomDensity_th']  = df.groupby('price_level')['RoomDensity'] \
                           .transform(lambda x: x.quantile(0.75))

# ì§€ì—­ë“¤ ë¶„ë¦¬í•˜ëŠ” df ìƒì„±
high_df = df[df['price_level'] == 'High'].copy()
mid_df  = df[df['price_level'] == 'Mid'].copy()
low_df  = df[df['price_level'] == 'Low'].copy()

```

# {.sidebar width="150px"}

##  í—ˆìœ„ë§¤ë¬¼ì´ë€?

- ê°€ê²© ëŒ€ë¹„ ê° ì¡°ê±´ì´ 
- ì‹œì¥ í‰ê· ì„ í¬ê²Œ ë²—ì–´ë‚œ ê²½ìš°
- ì´ìƒì¹˜ë¡œ ì •ì˜


 

## [íƒì§€ë°©ë²•]{style="font-size: 14px;"}

1. ê¸°ì¤€ ë³„ ì ìˆ˜ì œ

2. íšŒê·€ë¶„ì„



# ë°œí‘œ ì‹œì‘

<div style="display: flex; gap: 10px; align-items: flex-start;">
  <img src="imagebox/fakeroom1.png" style="width: 49%;" alt="ì²« ë²ˆì§¸ ì´ë¯¸ì§€">
  <img src="imagebox/fakeroom2.png" style="width: 49%;" alt="ë‘ ë²ˆì§¸ ì´ë¯¸ì§€">
</div> 


# ê°œìš”

## Row {height="15%"}

### Column {width="50%"}

::: card

### [ì–´ë”” ìˆë‹ˆ í—ˆìœ„ë§¤ë¬¼]{style="font-size: 30px;"}

<img src="imagebox/igotyou.png" alt="ì¡ì•˜ë‹¤ ìš”ë†ˆ" style="width: 100%;"/>

-   ì—ì„ìŠ¤(Ames) ë„ì‹œì˜ í—ˆìœ„ë§¤ë¬¼ íƒì§€

:::

### Column {width="50%"}

::: card

### [Ames ë„ì‹œ íŠ¹ì§•]{style="font-size: 30px;"}

-   ìœ„ì¹˜: ë¯¸êµ­ ì•„ì´ì˜¤ì™€ì£¼ ì¤‘ë¶€, ë””ëª¨ì¸ ë¶ìª½ ì•½ 50km
-   ì¸êµ¬: ì•½ 66,000ëª… (2020ë…„ ê¸°ì¤€)
-   íŠ¹ì§•:

1.  ì•„ì´ì˜¤ì™€ ì£¼ë¦½ëŒ€í•™êµ ì†Œì¬ (í•™ìƒ ìˆ˜ ì•½ 30,000ëª…, ì „ì²´ ì¸êµ¬ì˜ ì•½ 45%)
2.  ì•ˆì •ëœ ì£¼ê±° í™˜ê²½ê³¼ í™œë°œí•œ ì„ëŒ€ ì‹œì¥ (ì„ëŒ€ ê°€êµ¬ ë¹„ìœ¨ ì•½ 55%)
3.  ì Šì€ ì¸êµ¬ ë¹„ì¤‘ ë†’ê³  êµìœ¡ ì¤‘ì‹¬ ë„ì‹œ (20\~34ì„¸ ì¸êµ¬ ë¹„ì¤‘ ì•½ 40%)

:::

## Row {height="35%"}

### Column {width="50%"}

::: card

### Ames [ìœ„ì¹˜ ë° ì§€ì—­ ë¶„í¬]{style="font-size: 30px;"}

```{python}
import plotly.express as px

# ìƒ‰ìƒ ë§µí•‘
color_map = {
    'High': '#e41a1c',   # ë¹¨ê°•
    'Mid': '#ff7f00',    # ì£¼í™©
    'Low': '#4daf4a'     # ì´ˆë¡
}

# ì§€ë„ ì‹œê°í™”
fig_map = px.scatter_mapbox(
    df,
    lat='Latitude',
    lon='Longitude',
    color='price_level',
    color_discrete_map=color_map,
    hover_name='Neighborhood',
    hover_data={
        'SalePrice': True,
        'price_level': True,
        'Latitude': False,
        'Longitude': False
    },
    zoom=11,
    height=500
)

# ìŠ¤íƒ€ì¼ ë° ë ˆì´ì•„ì›ƒ ì„¤ì • (ìˆ˜ì •ëœ ë¶€ë¶„ í¬í•¨)
fig_map.update_layout(
    mapbox_style="open-street-map",
    mapbox_center={"lat": 42.03, "lon": -93.63},
    margin={"r": 0, "t": 30, "l": 0, "b": 0},  # ì§€ë„ ì—¬ë°± ìœ ì§€
    legend=dict(
        title='Price Level',
        x=1,  # x=1 â†’ ìš°ì¸¡ ë
        y=1,  # y=1 â†’ ìƒë‹¨ìœ¼ë¡œ
        xanchor='right',  # 'right'ë¡œ ì •ë ¬
        yanchor='top',  # 'top'ìœ¼ë¡œ ì •ë ¬
        bgcolor='rgba(255, 255, 255, 0.6)',
        bordercolor='lightgray',
        borderwidth=1
    ),
    font=dict(size=14, color='black'),
)

```

-   Ames ì§€ì—­ì˜ í‰ê·  ì£¼íƒê°€ê²© ê¸°ì¤€
-   ìƒÂ·ì¤‘Â·í•˜ë¡œ ë¶„ë¥˜
-   ê° ì ì€ ê°œë³„ ì£¼íƒì„ ì˜ë¯¸

:::

### Column {width="50%"}

::: card

### [ğŸ˜ ê°€ê²© ë³„ ê·¸ë£¹ ë¶„ë¥˜]{style="font-size: 30px;"}

```{python}
# ê°€ê²© ìˆ˜ì¤€ë³„ SalePrice ë¶„í¬
import plotly.express as px
fig = px.histogram(df, x='SalePrice', 
                    color='price_level', 
                    opacity=0.6)
fig.show()

```
- mid: ì£¼íƒ ë‹¤ìˆ˜ê°€ ë¶„í¬í•´ ì‹œì¥ì˜ ì¤‘ì‹¬ ì—­í• 
- low: ê°€ê²© ë¶„í¬ê°€ ì¢ê³  ê· ì§ˆí•œ íŠ¹ì„±
- high: ê±°ë˜ëŠ” ì ì§€ë§Œ ê°€ê²© ë³€ë™ í­ì´ í¬ê³  ë‹¤ì–‘ì„± ì¡´ì¬

:::



## Row {height="20%"}


### ì§€ì—­ë³„ ì£¼íƒ ê°€ê²© êµ¬ê°„ ë¶„ë¥˜

| ê°€ê²© êµ¬ê°„ | í‰ê·  ê°€ê²© ë²”ìœ„ (USD) | ì£¼ìš” ì§€ì—­ |
|----|----|----|
| ğŸ”º **ê³ ê°€ ì§€ì—­ (High)** | â‰¥ 217,676 | NoRidge, NridgHt, StoneBr, Veenker, Greens, Timber |
| âš–ï¸ **ì¤‘ê°„ ì§€ì—­ (Mid)** | 136,144 \~ 217,675 | CollgCr, Mitchel, NAmes, SawyerW, OldTown, Crawfor, Edwards |
| ğŸ”» **ì €ê°€ ì§€ì—­ (Low)** | â‰¤ 136,143 | MeadowV, BrDale, IDOTRR, Landmrk, Blueste |

> -   `Neighborhood`ë³„ í‰ê·  `SalePrice`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ìœ„ìˆ˜(Quantile)ë¥¼ ê³„ì‚°í•˜ì—¬ ê³ ê°€/ì¤‘ê°„/ì €ê°€ë¡œ ë¶„ë¥˜í•¨\
> -   ìƒìœ„ 25% ì´ìƒ: ê³ ê°€ ì§€ì—­, ì¤‘ìœ„ 50%: ì¤‘ê°„ ì§€ì—­, í•˜ìœ„ 25% ì´í•˜: ì €ê°€ ì§€ì—­


## Row {height="30%"}

::: card

ğŸ”º ê³ ê°€ ì§€ì—­ (High)

-   í‰ê·  ì£¼íƒ ê°€ê²©ì´ ë†’ê³  ê³ ê¸‰ ì£¼íƒ ë°€ì§‘
-   ìµœì‹  ê±´ì¶•/ë¦¬ëª¨ë¸ë§, í’ˆì§ˆ ìš°ìˆ˜
-   ë„“ì€ ë©´ì ê³¼ ë¶€ëŒ€ì‹œì„¤ ì™„ë¹„
-   ê³ ê¸‰ ë‹¨ë…ì£¼íƒ ì¤‘ì‹¬, ì¡°ìš©í•œ í™˜ê²½
-   ê±°ë˜ëŸ‰ì€ ì ì§€ë§Œ í¬ì†Œì„± ì¡´ì¬

:::

:::  card

âš–ï¸ ì¤‘ê°„ ì§€ì—­ (Mid)

-   Ames í‰ê·  ìˆ˜ì¤€ ì£¼íƒ ë¶„í¬
-   ë‹¤ì–‘í•œ ì£¼ê±° í˜•íƒœ(ë‹¨ë…, íƒ€ìš´í•˜ìš°ìŠ¤ ë“±)
-   ì Šì€ì¸µ/ëŒ€í•™ìƒ ì„ëŒ€ ìˆ˜ìš” ì¡´ì¬
-   ì¸í”„ë¼ ì–‘í˜¸, ê°€ì¡± ì„ í˜¸ ì§€ì—­
-   ê±°ë˜ëŸ‰ ë§ê³  ì‹œì¥ ë‚´ í™œë°œ

:::


:::  card

ğŸ”» ì €ê°€ ì§€ì—­ (Low)

-   í‰ê·  ì£¼íƒ ê°€ê²© ë‚®ê³  ì¼ë¶€ ë…¸í›„
-   ìœ ì§€ ê´€ë¦¬ ìƒíƒœ ì¤‘í•˜ ìˆ˜ì¤€
-   ì†Œí˜• ì„ëŒ€ ì£¼íƒ ë¹„ì¤‘ ë†’ìŒ
-   ì†ŒìŒ, ìƒì—…ì§€ ì¸ì ‘ ë“±ìœ¼ë¡œ ì„ í˜¸ë„ ë‚®ìŒ
-   ê±°ë˜ëŸ‰ ì ê³  ì •ë³´ ë¶€ì¡±

:::




# 2ì¥

## Columns

<div style="border: 2px solid #DC143C; border-radius: 15px; padding: 15px; background-color: #fff5f5;">
  <span style="font-size: 25px; font-weight: bold; color: #DC143C;">
    ğŸ“Œ ë¶„ì„ ê³¼ì •
  </span><br><br>
  6ê°€ì§€ ì¡°ê±´ì„ ë°”íƒ•ìœ¼ë¡œ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ê³ , 3ì  ì´ìƒì— í•´ë‹¹ë˜ëŠ” í—ˆìœ„ë§¤ë¬¼ì„ ì¶”ì¶œí•œë‹¤. <br>
  ì´í›„ íšŒê·€ ëª¨ë¸ì„ í†µí•´ í—ˆìœ„ë§¤ë¬¼ì„ ì¶”ì¶œí•œ ë’¤, ê³µí†µ í—ˆìœ„ë§¤ë¬¼ì„ ì¶”ì¶œí•œë‹¤.
  <br><br>

</div>


## Row {.tabset}

### [ì ìˆ˜ì œ íƒì§€]{style="font-size: 40px;"}

:::{.card}
```{python}
# ê·¸ë£¹ë³„ ì‹œê°í™” : ë°•ìŠ¤í”Œë¡¯
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# ì„œë¸Œí”Œë¡¯ ìƒì„± (ê°€ë¡œë¡œ 3ê°œ)
fig1 = make_subplots(rows=1, cols=3, subplot_titles=("GrLivArea by Price Level", 
                                                    "YearRemodAdd by Price Level", 
                                                    "RoomDensity by Price Level"))

# GrLivArea
for level in df['price_level'].unique():
    fig1.add_trace(
        go.Box(y=df[df['price_level'] == level]['GrLivArea'],
               name=level,
               boxmean=True),
        row=1, col=1
    )
# YearRemodAdd
for level in df['price_level'].unique():
    fig1.add_trace(
        go.Box(y=df[df['price_level'] == level]['YearRemodAdd'],
               name=level,
               boxmean=True),
        row=1, col=2
    )
# RoomDensity
for level in df['price_level'].unique():
    fig1.add_trace(
        go.Box(y=df[df['price_level'] == level]['RoomDensity'],
               name=level,
               boxmean=True),
        row=1, col=3
    )

# ì „ì²´ ë ˆì´ì•„ì›ƒ ì„¤ì •
fig1.update_layout(
    height=500, width=1200,
    showlegend=False
)

fig1.show();
```

<span style="font-size: 25px;">
  âœ”**GrLivArea** : ì§€ìƒì¸µ ë©´ì  <br>
  âœ”**YearRemodAdd** : ë¦¬ëª¨ë¸ë§ <br>
  âœ”**RoomDensity** : ë°© ë°€ë„ (ë°©ìˆ˜/ë©´ì )
<span>

:::

:::{.card}
```{python}
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# ì„œë¸Œí”Œë¡¯ ìƒì„±: 3í–‰ 3ì—´
fig2 = make_subplots(
    rows=3, cols=3,
    subplot_titles=[
        'OverallQual - Low', 'OverallQual - Mid', 'OverallQual - High',
        'OverallCond - Low', 'OverallCond - Mid', 'OverallCond - High',
        'Amenities - Low', 'Amenities - Mid', 'Amenities - High'
    ]
)
# ë³€ìˆ˜ ë¦¬ìŠ¤íŠ¸ ë° ì‹œê°í™” ì„¸íŒ…
variables = ['OverallQual', 'OverallCond', 'amenities']
colors = ['skyblue', 'salmon', 'lightgreen']
bins_dict = {
    'OverallQual': list(range(1, 11)),
    'OverallCond': list(range(1, 11)),
    'amenities': list(range(0, 6))
}
# ê·¸ë˜í”„ ì¶”ê°€
for row, var in enumerate(variables, start=1):
    for col, level in enumerate(['Low', 'Mid', 'High'], start=1):
        subset = df[df['price_level'] == level]
        fig2.add_trace(
            go.Histogram(
                x=subset[var],
                xbins=dict(
                    start=min(bins_dict[var]),
                    end=max(bins_dict[var]),
                    size=1
                ),
                marker_color=colors[row-1],
                name=f'{var} - {level}',
                showlegend=False
            ),
            row=row, col=col
        )
# ì „ì²´ ë ˆì´ì•„ì›ƒ ì¡°ì •
fig2.update_layout(
    height=900, width=1000,
    bargap=0.1
)

fig2.show();

```

<span style="font-size: 25px;">
  âœ”**OverallQual** : ì§€ìƒì¸µ ë©´ì  <br>
  âœ”**OverallCond** : ë¦¬ëª¨ë¸ë§ <br>
  âœ”**Amenities** : ë°© ë°€ë„ (ë°©ìˆ˜/ë©´ì )
</span>

:::

## Row

```{python}
# High ê·¸ë£¹
high_med      = high_df['SalePrice'].median()
high_area_th  = high_df['GrLivArea'].quantile(0.75)
high_remod_th = high_df['YearRemodAdd'].quantile(0.75)
high_den_th   = high_df['RoomDensity'].quantile(0.75)

high_df['flag_high_qual']      = (high_df['OverallQual']  >= 9).astype(int)
high_df['flag_good_condition'] = (high_df['OverallCond']  >= 6).astype(int)
high_df['flag_high_area']      = (high_df['GrLivArea']    >= high_area_th ).astype(int)
high_df['flag_high_remod']     = (high_df['YearRemodAdd'] >= high_remod_th).astype(int)
high_df['flag_high_density']   = (high_df['RoomDensity']  >= high_den_th  ).astype(int)
high_df['flag_high_amenities'] = (high_df['amenities']    >= 3            ).astype(int)

# Mid ê·¸ë£¹
mid_med      = mid_df['SalePrice'].median()
mid_area_th  = mid_df['GrLivArea'].quantile(0.75)
mid_remod_th = mid_df['YearRemodAdd'].quantile(0.75)
mid_den_th   = mid_df['RoomDensity'].quantile(0.75)

mid_df['flag_mid_qual']        = (mid_df['OverallQual']  >= 8).astype(int)
mid_df['flag_good_condition']  = (mid_df['OverallCond']  >= 6).astype(int)
mid_df['flag_mid_area']        = (mid_df['GrLivArea']    >= mid_area_th ).astype(int)
mid_df['flag_mid_remod']       = (mid_df['YearRemodAdd'] >= mid_remod_th).astype(int)
mid_df['flag_mid_density']     = (mid_df['RoomDensity']  >= mid_den_th  ).astype(int)
mid_df['flag_mid_amenities']   = (mid_df['amenities']    >= 3            ).astype(int)

# Low ê·¸ë£¹
low_med      = low_df['SalePrice'].median()
low_area_th  = low_df['GrLivArea'].quantile(0.75)
low_remod_th = low_df['YearRemodAdd'].quantile(0.75)
low_den_th   = low_df['RoomDensity'].quantile(0.75)

low_df['flag_low_qual']        = (low_df['OverallQual']  >= 7).astype(int)
low_df['flag_good_condition']  = (low_df['OverallCond']  >= 8).astype(int)
low_df['flag_low_area']        = (low_df['GrLivArea']    >= low_area_th ).astype(int)
low_df['flag_low_remod']       = (low_df['YearRemodAdd'] >= low_remod_th).astype(int)
low_df['flag_low_density']     = (low_df['RoomDensity']  >= low_den_th  ).astype(int)
low_df['flag_low_amenities']   = (low_df['amenities']    >= 3            ).astype(int)

for name, gdf, med in [
    ('High', high_df, high_med),
    ('Mid',  mid_df,  mid_med),
    ('Low',  low_df,  low_med),
]:
    # Median ì´í•˜ì¸ ë§¤ë¬¼ë§Œ ë³µì‚¬ë³¸ìœ¼ë¡œ
    filt = gdf.loc[gdf['SalePrice'] <= med].copy()
    
    # ì´ ê·¸ë£¹ì˜ flag ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
    flags = [c for c in filt.columns 
             if c.startswith(f'flag_{name.lower()}') or c == 'flag_good_condition']

# (1) score ê³„ì‚°: 6ê°€ì§€ ì¡°ê±´ì„ í•œ ì¤„ë¡œ ì§‘ê³„
qual_th = {'Low':7,'Mid':8,'High':9}
cond_th = {'Low':8,'Mid':6,'High':6}

df['score'] = df.apply(lambda r: 
    int(r['OverallQual']  >= qual_th[r['price_level']]) +
    int(r['OverallCond']  >= cond_th [r['price_level']]) +
    int(r['GrLivArea']    >= r['GrLivArea_th']) +
    int(r['YearRemodAdd'] >= r['YearRemodAdd_th']) +
    int(r['RoomDensity']  >= r['RoomDensity_th']) +
    int(r['amenities']    >= 3),
    axis=1
)

# (2) ê·¸ë£¹ë³„ ì¤‘ìœ„ê°’ ì´í•˜ ì—¬ë¶€
median_price = df.groupby('price_level')['SalePrice'].transform('median')

# (3) suspect_flag ìƒì„±
df['suspect_flag'] = (df['SalePrice'] <= median_price) & (df['score'] >= 3)

# (4) í—ˆìœ„ë§¤ë¬¼ í›„ë³´ë§Œ ì¶”ì¶œ
suspect_df = df[df['suspect_flag']].copy()


```

```{python}
from IPython.display import display, HTML

html_table = """
<div style="display: flex; flex-direction: row; gap: 20px; justify-content: space-between;">
  <div style="width: 33%; padding: 10px; border: 2px solid #4CAF50; border-radius: 15px; background-color: #e8f5e9;">
    <span style="font-size: 32px; font-weight: bold; color: #4CAF50;">ğŸ“Š **High ê·¸ë£¹ ë¶„ì„**</span>
    <br><br>
    <strong style="font-size: 24px;">ì¡°ê±´ í”Œë˜ê·¸:</strong><br>
    <ul style="font-size: 20px;">
      <li>flag_high_qual: 3</li>
      <li>flag_good_condition: 22</li>
      <li>flag_high_area: 10</li>
      <li>flag_high_remod: 76</li>
      <li>flag_high_density: 93</li>
      <li>flag_high_amenities: 3</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score ë¶„í¬:</strong><br>
    <ul style="font-size: 20px;">
      <li>0: 76</li>
      <li>1: 103</li>
      <li>2: 47</li>
      <li>3: 2</li>
      <li>4: 1</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score â‰¥ 3ì¸ ê±´ìˆ˜: 3ê±´</strong>
  </div>

  <div style="width: 33%; padding: 10px; border: 2px solid #2196F3; border-radius: 15px; background-color: #e3f2fd;">
    <span style="font-size: 32px; font-weight: bold; color: #2196F3;">ğŸ“Š **Mid ê·¸ë£¹ ë¶„ì„**</span>
    <br><br>
    <strong style="font-size: 24px;">ì¡°ê±´ í”Œë˜ê·¸:</strong><br>
    <ul style="font-size: 20px;">
      <li>flag_mid_qual: 2</li>
      <li>flag_good_condition: 366</li>
      <li>flag_mid_area: 53</li>
      <li>flag_mid_remod: 107</li>
      <li>flag_mid_density: 296</li>
      <li>flag_mid_amenities: 37</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score ë¶„í¬:</strong><br>
    <ul style="font-size: 20px;">
      <li>0: 158</li>
      <li>1: 348</li>
      <li>2: 172</li>
      <li>3: 51</li>
      <li>4: 4</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score â‰¥ 3ì¸ ê±´ìˆ˜: 55ê±´</strong>
  </div>

  <div style="width: 33%; padding: 10px; border: 2px solid #FF5722; border-radius: 15px; background-color: #ffebee;">
    <span style="font-size: 32px; font-weight: bold; color: #FF5722;">ğŸ“Š **Low ê·¸ë£¹ ë¶„ì„**</span>
    <br><br>
    <strong style="font-size: 24px;">ì¡°ê±´ í”Œë˜ê·¸:</strong><br>
    <ul style="font-size: 20px;">
      <li>flag_low_qual: 4</li>
      <li>flag_good_condition: 30</li>
      <li>flag_low_area: 24</li>
      <li>flag_low_remod: 59</li>
      <li>flag_low_density: 131</li>
      <li>flag_low_amenities: 10</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score ë¶„í¬:</strong><br>
    <ul style="font-size: 20px;">
      <li>0: 133</li>
      <li>1: 155</li>
      <li>2: 30</li>
      <li>3: 13</li>
      <li>4: 1</li>
    </ul>
    <br>
    <strong style="font-size: 24px;">Score â‰¥ 3ì¸ ê±´ìˆ˜: 14ê±´</strong>
  </div>
</div>
"""

display(HTML(html_table))

```

# 3ì¥

## Row {height=30%}
### {width=50%}

<div style="border: 2px solid #DC143C; border-radius: 15px; padding: 15px; background-color: #fff5f5;">
  <span style="font-size: 25px; font-weight: bold; color: #DC143C;">
    â— ì¡°ê±´ í”Œë˜ê·¸ ê²°ê³¼
  </span><br><br>
  72ê±´ì˜ í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬ í›„ë³´ ì¶”ì¶œ <br>
  ìš°ì¸¡ ì§€ë„ë¥¼ í†µí•´ ê·¸ë£¹ë³„ í—ˆìœ„ë§¤ë¬¼ ë¶„í¬ í™•ì¸ ê°€ëŠ¥í•¨
  <br><br>

</div>

```{python}
import pandas as pd

# suspect_dfì—ì„œ í•„ìš”í•œ ì—´ë§Œ
suspect_neighborhoods_df = suspect_df[['Neighborhood', 'price_level']].copy()

# HTMLë¡œ ë³€í™˜
suspect_neighborhoods_html = suspect_neighborhoods_df.to_html(index=False)

# ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ ì…í˜€ì„œ ì¶œë ¥
from IPython.display import HTML, display

display(HTML(f"""
<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
{suspect_neighborhoods_html}
</div>
"""))

```


### {width=50%}

```{python}
import plotly.express as px

center = {
    "lat": suspect_df["Latitude"].mean(),
    "lon": suspect_df["Longitude"].mean()
}

# í—ˆìœ„ë§¤ë¬¼ë§Œ í•„í„°ë§ (suspect_flagê°€ Trueì¸ ë°ì´í„°ë§Œ)
suspect_only_df = suspect_df[suspect_df['suspect_flag'] == True]

fig = px.scatter_mapbox(
    suspect_only_df,  # í—ˆìœ„ë§¤ë¬¼ ë°ì´í„°ë§Œ ì‹œê°í™”
    lat="Latitude",
    lon="Longitude",
    color="price_level",  # ê°€ê²© ìˆ˜ì¤€ì— ë”°ë¼ ìƒ‰ìƒ êµ¬ë¶„
    size="SalePrice",  # ë§ˆì»¤ í¬ê¸°ëŠ” íŒë§¤ ê°€ê²©ì— ë”°ë¼ ì„¤ì •
    hover_name="Neighborhood",
    hover_data=["SalePrice", "GrLivArea"],
    labels={
        "Latitude": "ìœ„ë„",
        "Longitude": "ê²½ë„",
        "price_level": "ë™ë„¤ ê°€ê²© ìˆ˜ì¤€",
        "Neighborhood": "ì§€ì—­(ë™ë„¤)",
        "SalePrice": "íŒë§¤ ê°€ê²©($)",
        "GrLivArea": "ê±°ì‹¤ ë©´ì (ftÂ²)"
    },
    zoom=12,                    
    center=center,               
    height=600,
    mapbox_style="open-street-map",
    title="Ames Housing: Price Level by Neighborhood (í—ˆìœ„ë§¤ë¬¼ë§Œ)"
)

fig.show()

```




# 4ì¥

## íšŒê·€ë¶„ì„ ê³¼ì • ì„¤ëª…

íšŒê·€ë¶„ì„ ëª¨ë¸ì„ ì ìš©í•˜ì—¬ í—ˆìœ„ë§¤ë¬¼ì„ ì°¾ì•„ë‚¼ ê²½ìš°, ì ìˆ˜ì œë¡œ ì¶”ë ¤ì§„ í—ˆìœ„ë§¤ë¬¼ê³¼ ë¬´ì—‡ì´ ê°™ê³ , ë¬´ì—‡ì´ ë‹¤ë¥¸ì§€ ë¹„êµê°€ëŠ¥

1.  ì¢…ì†ë³€ìˆ˜: 'SalePrice' <br> ë…ë¦½ë³€ìˆ˜: 'OverallQual', 'OverallCond', 'GrLivArea', 'YearRemodAdd', 'RoomDensity', 'amenities' <br> ì ìˆ˜ì œì—ì„œ ì‚¬ìš©í–ˆë˜ 6ê°€ì§€ ì¡°ê±´ì—ì„œ ë…ë¦½ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜´. ì´ë¥¼ í†µí•´ ì ìˆ˜ì œ ë°©ì‹ê³¼ ë¹„êµê°€ ê°€ëŠ¥í•¨.

<br>

2.  ëª¨ë“  ë³€ìˆ˜ì˜ ì˜í–¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ Ridge íšŒê·€ ì ìš©. <br> ë˜í•œ ë°ì´í„°ë¥¼ í•™ìŠµìš© 80%, í…ŒìŠ¤íŠ¸ìš© 20%ë¡œ ë¶„ë¦¬í•˜ê³ , 5-fold êµì°¨ ê²€ì¦ ìˆ˜í–‰. <br> êµì°¨ ê²€ì¦ì„ í†µí•´ ëª¨ë¸ì˜ ì•ˆì •ì„±ì„ í™•ë³´í•˜ê³ , ë‹¤ì–‘í•œ ì •ê·œí™” ê°•ë„(Î±)ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì—¬ ìµœì ì˜ ì˜ˆì¸¡ ì„±ëŠ¥ì„ ê°€ì§„ ëª¨ë¸ì„ ì„ íƒí•¨. <br> ì„±ëŠ¥ í‰ê°€ ì§€í‘œë¡œ 'neg_mean_squared_error'(ìŒì˜ í‰ê·  ì œê³± ì˜¤ì°¨)ë¥¼ ì‚¬ìš©.<br> Pythonì˜ scikit-learnì—ì„œëŠ” ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ì¢‹ì€ ëª¨ë¸ë¡œ í‰ê°€í•˜ëŠ” ê·œì¹™ì´ ìˆì–´ ì˜¤ì°¨ ì§€í‘œë¥¼ ìŒìˆ˜í™”í•˜ì—¬ ì‚¬ìš©.

<br>

3.  í—ˆìœ„ë§¤ë¬¼ íŒë³„ì„ ìœ„í•´ ì‹¤ì œê°€ê²©ê³¼ ì˜ˆì¸¡ê°€ê²©ì˜ ì°¨ì´(ì”ì°¨)ë¥¼ ê³„ì‚°í•˜ê³ , í•˜ìœ„ 2.8%(72/2579)ë¥¼ í—ˆìœ„ë§¤ë¬¼ë¡œ ë¶„ë¥˜. <br> ì´ëŠ” ì ìˆ˜ì œì—ì„œ ë°œê²¬í•œ í—ˆìœ„ë§¤ë¬¼ ìˆ˜ì™€ ë™ì¼í•œ ë¹„ìœ¨ì„ ì ìš©í•˜ì—¬ ë‘ ë°©ë²•ë¡ ì˜ ê²°ê³¼ë¥¼ ì§ì ‘ ë¹„êµí•  ìˆ˜ ìˆê²Œ í•¨.

<br>

4.  ê° ê°€ê²© ìˆ˜ì¤€(Low, Mid, High) ê·¸ë£¹ë³„ë¡œ ë³„ë„ì˜ ëª¨ë¸ì„ êµ¬ì¶•í•˜ì—¬ ê°€ê²©ëŒ€ë³„ íŠ¹ì„±ì„ ë°˜ì˜í•œ í—ˆìœ„ë§¤ë¬¼ íƒì§€ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•¨.

##  {.tabset}

### Low ê·¸ë£¹

::: card
```{python}

import numpy as np
import pandas as pd
from sklearn.linear_model import RidgeCV
from sklearn.model_selection import train_test_split
from sklearn.metrics import r2_score, mean_squared_error
import plotly.express as px

# ì‚¬ìš©í•  6ê°œ í”¼ì²˜ì™€ íƒ€ê²Ÿ ì •ì˜
features = [
    'OverallQual',
    'OverallCond',
    'GrLivArea',
    'YearRemodAdd',
    'RoomDensity',
    'amenities'
]
target = 'SalePrice'

level = 'Low'
df_lvl = df[df['price_level'] == level].copy()

X = df_lvl[features]
y = df_lvl[target]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

ridge = RidgeCV(alphas=np.logspace(-4, 1, 10), cv=5, scoring='neg_mean_squared_error')
ridge.fit(X_train, y_train)

# â€” ì˜ˆì¸¡ ë° ì”ì°¨ ê³„ì‚° â€”
df_lvl['predicted'] = ridge.predict(X)
df_lvl['residual']  = df_lvl['SalePrice'] - df_lvl['predicted']
thresh = df_lvl['residual'].quantile(72/2579)
df_lvl['ridge_flag'] = df_lvl['residual'] <= thresh


#â€” ì„¤ëª…ë ¥(RÂ²) ë° ìµœì  Î± ê³„ì‚°Â·ì¶œë ¥ â€”
r2    = r2_score(y, ridge.predict(X))
alpha = ridge.alpha_
print(f"ì„¤ëª…ë ¥ (RÂ²): {r2:.3f}")
print(f"ìµœì  Î± (alpha): {alpha:.3g}/n")


import plotly.express as px

def make_figure(df, level):
    # 1) scatter - ì‹¤ì œê°€ê²©(xì¶•)ê³¼ ì˜ˆì¸¡ê°€ê²©(yì¶•) ì„¤ì •
    fig = px.scatter(
        df,
        x='SalePrice',     
        y='predicted',     
        color='ridge_flag',
        color_discrete_map={True: 'purple', False: 'lightgray'},
        opacity=0.7,
        title=f"ì‹¤ì œê°€ê²© vs ì˜ˆì¸¡ê°€ê²© ({level}) - Ridge Regression",
        labels={
            'SalePrice': 'ì‹¤ì œê°€ê²©($)',
            'predicted': 'ì˜ˆì¸¡ê°€ê²©($)',
            'ridge_flag': 'í—ˆìœ„ë§¤ë¬¼ ì—¬ë¶€'
        }
    )
    
    # 2) ëŒ€ê°ì„  (y = x)
    mn = min(df['predicted'].min(), df['SalePrice'].min())
    mx = max(df['predicted'].max(), df['SalePrice'].max())
    fig.add_shape(
        type='line',
        x0=mn, y0=mn, x1=mx, y1=mx,
        line=dict(color='black', dash='dash')
    )
    
    # 3) ì¶• ì œëª© & 1:1 ë¹„ìœ¨ ê³ ì • ë° ë²”ë¡€ ê°œì„ 
    fig.update_layout(
        width=650,         
        height=600,
        margin=dict(l=80, r=60, t=80, b=80),
        xaxis=dict(
            title='ì‹¤ì œê°€ê²©',
            scaleanchor='y', 
            scaleratio=1,
            title_standoff=15
        ),
        yaxis=dict(
            title='ì˜ˆì¸¡ê°€ê²©',
            title_standoff=15
        ),
        # 4) ë²”ë¡€ ìœ„ì¹˜ì™€ í˜•ì‹ ê°œì„  ('itemname' ì†ì„± ì œê±°)
        legend=dict(
            title=None,  # ë²”ë¡€ ì œëª© ì œê±°
            yanchor="top",
            y=0.99,
            xanchor="left",
            x=0.01,
            bgcolor="rgba(255, 255, 255, 0.8)",
            bordercolor="Black",
            borderwidth=1,
            font=dict(size=12)
        )
    )
    
    # 5) ë²”ë¡€ í…ìŠ¤íŠ¸ ì§ì ‘ ì—…ë°ì´íŠ¸
    new_names = {'True': 'í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬', 'False': 'ì •ìƒ'}
    fig.for_each_trace(lambda t: t.update(name = new_names[t.name]))
    
    return fig

# ì‚¬ìš©
fig = make_figure(df_lvl, level)
fig
```

### Low ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ì •ë¦¬

```{python}
# 1) í†µê³„ ê³„ì‚°
flagged = df_lvl[df_lvl['ridge_flag']]
total   = len(df_lvl)
count   = len(flagged)
pct     = count/total*100

# 4) ê²°ê³¼ ì¶œë ¥
print(f"â–¶ ì „ì²´ ìƒ˜í”Œ ìˆ˜: {total}ê°œ")
print(f"â–¶ í—ˆìœ„ë§¤ë¬¼ ìˆ˜: {count}ê°œ ({pct:.1f}%)/n")
```

#### í—ˆìœ„ë§¤ë¬¼ ëª©ë¡ (ì •ë ¬ ê¸°ì¤€ : residual)

```{python}
# 5) ëª©ë¡
flagged[['Neighborhood','SalePrice','predicted','residual']].sort_values('residual')

```

#### Low ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ìœ„ì¹˜ ì§€ë„

```{python}

# 1) í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬ë§Œ í•„í„°ë§ (ì´ë¯¸ flaggedì— ì €ì¥ë¨)
suspects = flagged.copy()

# 2) ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚°
center = {
    "lat": suspects["Latitude"].mean(),
    "lon": suspects["Longitude"].mean()
}

# 3) Mapbox ì‚°ì ë„ ê·¸ë¦¬ê¸°
fig = px.scatter_mapbox(
    suspects,
    lat="Latitude",
    lon="Longitude",
    hover_name="Neighborhood",
    hover_data=["SalePrice","predicted","residual"],
    labels={
        "Latitude": "ìœ„ë„",
        "Longitude": "ê²½ë„",
        "price_level": "ë™ë„¤ ê°€ê²© ìˆ˜ì¤€",
        "Neighborhood": "ì§€ì—­(ë™ë„¤)",
        "SalePrice": "ì‹¤ì œ ê°€ê²©($)",
        "predicted": "ì˜ˆì¸¡ ê°€ê²©($)",
        "residual": "ì”ì°¨(ì‹¤ì œ ê°€ê²© - ì˜ˆì¸¡ ê°€ê²©)"
    },
    color_discrete_sequence=["purple"],
    zoom=11,
    center=center,
    width=600,    # ìº”ë²„ìŠ¤ ê°€ë¡œ(px)
    height=600,    # ìº”ë²„ìŠ¤ ì„¸ë¡œ(px)
    mapbox_style="open-street-map",
)

fig
```
:::

### Mid ê·¸ë£¹

::: card
```{python}

level = 'Mid'
df_lvl = df[df['price_level'] == level].copy()

X = df_lvl[features]
y = df_lvl[target]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

ridge = RidgeCV(alphas=np.logspace(-4, 1, 10), cv=5, scoring='neg_mean_squared_error')
ridge.fit(X_train, y_train)

df_lvl['predicted'] = ridge.predict(X)
df_lvl['residual']  = df_lvl['SalePrice'] - df_lvl['predicted']
thresh = df_lvl['residual'].quantile(72/2579)
df_lvl['ridge_flag'] = df_lvl['residual'] <= thresh

#â€” ì„¤ëª…ë ¥(RÂ²) ë° ìµœì  Î± ê³„ì‚°Â·ì¶œë ¥ â€”
r2    = r2_score(y, ridge.predict(X))
alpha = ridge.alpha_
print(f"ì„¤ëª…ë ¥ (RÂ²): {r2:.3f}")
print(f"ìµœì  Î± (alpha): {alpha:.3g}/n")



import plotly.express as px

def make_figure(df, level):
    # 1) scatter - ì‹¤ì œê°€ê²©(xì¶•)ê³¼ ì˜ˆì¸¡ê°€ê²©(yì¶•) ì„¤ì •
    fig = px.scatter(
        df,
        x='SalePrice',     
        y='predicted',     
        color='ridge_flag',
        color_discrete_map={True: 'purple', False: 'lightgray'},
        opacity=0.7,
        title=f"ì‹¤ì œê°€ê²© vs ì˜ˆì¸¡ê°€ê²© ({level}) - Ridge Regression",
        labels={
            'SalePrice': 'ì‹¤ì œê°€ê²©($)',
            'predicted': 'ì˜ˆì¸¡ê°€ê²©($)',
            'ridge_flag': 'í—ˆìœ„ë§¤ë¬¼ ì—¬ë¶€'
        }
    )
    
    # 2) ëŒ€ê°ì„  (y = x)
    mn = min(df['predicted'].min(), df['SalePrice'].min())
    mx = max(df['predicted'].max(), df['SalePrice'].max())
    fig.add_shape(
        type='line',
        x0=mn, y0=mn, x1=mx, y1=mx,
        line=dict(color='black', dash='dash')
    )
    
    # 3) ì¶• ì œëª© & 1:1 ë¹„ìœ¨ ê³ ì • ë° ë²”ë¡€ ê°œì„ 
    fig.update_layout(
        width=650,         
        height=600,
        margin=dict(l=80, r=60, t=80, b=80),
        xaxis=dict(
            title='ì‹¤ì œê°€ê²©',
            scaleanchor='y', 
            scaleratio=1,
            title_standoff=15
        ),
        yaxis=dict(
            title='ì˜ˆì¸¡ê°€ê²©',
            title_standoff=15
        ),
        # 4) ë²”ë¡€ ìœ„ì¹˜ì™€ í˜•ì‹ ê°œì„  ('itemname' ì†ì„± ì œê±°)
        legend=dict(
            title=None,  # ë²”ë¡€ ì œëª© ì œê±°
            yanchor="top",
            y=0.99,
            xanchor="left",
            x=0.01,
            bgcolor="rgba(255, 255, 255, 0.8)",
            bordercolor="Black",
            borderwidth=1,
            font=dict(size=12)
        )
    )
    
    # 5) ë²”ë¡€ í…ìŠ¤íŠ¸ ì§ì ‘ ì—…ë°ì´íŠ¸
    new_names = {'True': 'í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬', 'False': 'ì •ìƒ'}
    fig.for_each_trace(lambda t: t.update(name = new_names[t.name]))
    
    return fig

# ì‚¬ìš©
fig = make_figure(df_lvl, level)
fig
```

### Mid ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ì •ë¦¬

```{python}
# 1) í†µê³„ ê³„ì‚°
flagged = df_lvl[df_lvl['ridge_flag']]
total   = len(df_lvl)
count   = len(flagged)
pct     = count/total*100

# 4) ê²°ê³¼ ì¶œë ¥
print(f"â–¶ ì „ì²´ ìƒ˜í”Œ ìˆ˜: {total}ê°œ")
print(f"â–¶ í—ˆìœ„ë§¤ë¬¼ ìˆ˜: {count}ê°œ ({pct:.1f}%)/n")

```

#### í—ˆìœ„ë§¤ë¬¼ ëª©ë¡ (ì •ë ¬ ê¸°ì¤€ : residual)

```{python}
# 5) ëª©ë¡
flagged[['Neighborhood','SalePrice','predicted','residual']].sort_values('residual')
```

#### Mid ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ìœ„ì¹˜ ì§€ë„

```{python}

# 1) í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬ë§Œ í•„í„°ë§ (ì´ë¯¸ flaggedì— ì €ì¥ë¨)
suspects = flagged.copy()

# 2) ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚°
center = {
    "lat": suspects["Latitude"].mean(),
    "lon": suspects["Longitude"].mean()
}

# 3) Mapbox ì‚°ì ë„ ê·¸ë¦¬ê¸°
fig = px.scatter_mapbox(
    suspects,
    lat="Latitude",
    lon="Longitude",
    hover_name="Neighborhood",
    hover_data=["SalePrice","predicted","residual"],
    labels={
        "Latitude": "ìœ„ë„",
        "Longitude": "ê²½ë„",
        "price_level": "ë™ë„¤ ê°€ê²© ìˆ˜ì¤€",
        "Neighborhood": "ì§€ì—­(ë™ë„¤)",
        "SalePrice": "ì‹¤ì œ ê°€ê²©($)",
        "predicted": "ì˜ˆì¸¡ ê°€ê²©($)",
        "residual": "ì”ì°¨(ì‹¤ì œ ê°€ê²© - ì˜ˆì¸¡ ê°€ê²©)"
    },
    color_discrete_sequence=["purple"],
    zoom=11,
    center=center,
    width=600,    # ìº”ë²„ìŠ¤ ê°€ë¡œ(px)
    height=600,    # ìº”ë²„ìŠ¤ ì„¸ë¡œ(px)
    mapbox_style="open-street-map",
)

fig
```
:::

### High ê·¸ë£¹

::: card
```{python}

level = 'High'
df_lvl = df[df['price_level'] == level].copy()

X = df_lvl[features]
y = df_lvl[target]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

ridge = RidgeCV(alphas=np.logspace(-4, 1, 10), cv=5, scoring='neg_mean_squared_error')
ridge.fit(X_train, y_train)

df_lvl['predicted'] = ridge.predict(X)
df_lvl['residual']  = df_lvl['SalePrice'] - df_lvl['predicted']
thresh = df_lvl['residual'].quantile(72/2579)
df_lvl['ridge_flag'] = df_lvl['residual'] <= thresh


#â€” ì„¤ëª…ë ¥(RÂ²) ë° ìµœì  Î± ê³„ì‚°Â·ì¶œë ¥ â€”
r2    = r2_score(y, ridge.predict(X))
alpha = ridge.alpha_
print(f"ì„¤ëª…ë ¥ (RÂ²): {r2:.3f}")
print(f"ìµœì  Î± (alpha): {alpha:.3g}/n")


import plotly.express as px

def make_figure(df, level):
    # 1) scatter - ì‹¤ì œê°€ê²©(xì¶•)ê³¼ ì˜ˆì¸¡ê°€ê²©(yì¶•) ì„¤ì •
    fig = px.scatter(
        df,
        x='SalePrice',     
        y='predicted',     
        color='ridge_flag',
        color_discrete_map={True: 'purple', False: 'lightgray'},
        opacity=0.7,
        title=f"ì‹¤ì œê°€ê²© vs ì˜ˆì¸¡ê°€ê²© ({level}) - Ridge Regression",
        labels={
            'SalePrice': 'ì‹¤ì œê°€ê²©($)',
            'predicted': 'ì˜ˆì¸¡ê°€ê²©($)',
            'ridge_flag': 'í—ˆìœ„ë§¤ë¬¼ ì—¬ë¶€'
        }
    )
    
    # 2) ëŒ€ê°ì„  (y = x)
    mn = min(df['predicted'].min(), df['SalePrice'].min())
    mx = max(df['predicted'].max(), df['SalePrice'].max())
    fig.add_shape(
        type='line',
        x0=mn, y0=mn, x1=mx, y1=mx,
        line=dict(color='black', dash='dash')
    )
    
    # 3) ì¶• ì œëª© & 1:1 ë¹„ìœ¨ ê³ ì • ë° ë²”ë¡€ ê°œì„ 
    fig.update_layout(
        width=650,         
        height=600,
        margin=dict(l=80, r=60, t=80, b=80),
        xaxis=dict(
            title='ì‹¤ì œê°€ê²©',
            scaleanchor='y', 
            scaleratio=1,
            title_standoff=15
        ),
        yaxis=dict(
            title='ì˜ˆì¸¡ê°€ê²©',
            title_standoff=15
        ),
        # 4) ë²”ë¡€ ìœ„ì¹˜ì™€ í˜•ì‹ ê°œì„  ('itemname' ì†ì„± ì œê±°)
        legend=dict(
            title=None,  # ë²”ë¡€ ì œëª© ì œê±°
            yanchor="top",
            y=0.99,
            xanchor="left",
            x=0.01,
            bgcolor="rgba(255, 255, 255, 0.8)",
            bordercolor="Black",
            borderwidth=1,
            font=dict(size=12)
        )
    )
    
    # 5) ë²”ë¡€ í…ìŠ¤íŠ¸ ì§ì ‘ ì—…ë°ì´íŠ¸
    new_names = {'True': 'í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬', 'False': 'ì •ìƒ'}
    fig.for_each_trace(lambda t: t.update(name = new_names[t.name]))
    
    return fig

# ì‚¬ìš©
fig = make_figure(df_lvl, level)
fig
```

### High ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ì •ë¦¬

```{python}
# 1) í†µê³„ ê³„ì‚°
flagged = df_lvl[df_lvl['ridge_flag']]
total   = len(df_lvl)
count   = len(flagged)
pct     = count/total*100

# 4) ê²°ê³¼ ì¶œë ¥
print(f"â–¶ ì „ì²´ ìƒ˜í”Œ ìˆ˜: {total}ê°œ")
print(f"â–¶ í—ˆìœ„ë§¤ë¬¼ ìˆ˜: {count}ê°œ ({pct:.1f}%)/n")

```

#### í—ˆìœ„ë§¤ë¬¼ ëª©ë¡ (ì •ë ¬ ê¸°ì¤€ : residual)

```{python}
# 5) ëª©ë¡
flagged[['Neighborhood','SalePrice','predicted','residual']].sort_values('residual')
```

#### High ê·¸ë£¹ í—ˆìœ„ë§¤ë¬¼ ìœ„ì¹˜ ì§€ë„

```{python}

# 1) í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬ë§Œ í•„í„°ë§ (ì´ë¯¸ flaggedì— ì €ì¥ë¨)
suspects = flagged.copy()

# 2) ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚°
center = {
    "lat": suspects["Latitude"].mean(),
    "lon": suspects["Longitude"].mean()
}

# 3) Mapbox ì‚°ì ë„ ê·¸ë¦¬ê¸°
fig = px.scatter_mapbox(
    suspects,
    lat="Latitude",
    lon="Longitude",
    hover_name="Neighborhood",
    hover_data=["SalePrice","predicted","residual"],
    labels={
        "Latitude": "ìœ„ë„",
        "Longitude": "ê²½ë„",
        "price_level": "ë™ë„¤ ê°€ê²© ìˆ˜ì¤€",
        "Neighborhood": "ì§€ì—­(ë™ë„¤)",
        "SalePrice": "ì‹¤ì œ ê°€ê²©($)",
        "predicted": "ì˜ˆì¸¡ ê°€ê²©($)",
        "residual": "ì”ì°¨(ì‹¤ì œ ê°€ê²© - ì˜ˆì¸¡ ê°€ê²©)"
    },
    color_discrete_sequence=["purple"],
    zoom=11,
    center=center,
    width=600,    # ìº”ë²„ìŠ¤ ê°€ë¡œ(px)
    height=600,    # ìº”ë²„ìŠ¤ ì„¸ë¡œ(px)
    mapbox_style="open-street-map",
)

fig
```
:::

```{python}

import numpy as np
import pandas as pd
from sklearn.linear_model import RidgeCV
from sklearn.model_selection import train_test_split
from sklearn.metrics import r2_score, mean_squared_error
import plotly.express as px

# ì‚¬ìš©í•  6ê°œ í”¼ì²˜ì™€ íƒ€ê²Ÿ ì •ì˜ í”¼ì²˜: ì†ì„±
features = [
    'OverallQual',
    'OverallCond',
    'GrLivArea',
    'YearRemodAdd',
    'RoomDensity',
    'amenities'
]
target = 'SalePrice'

# price_levelë³„ ëª¨ë¸ í•™ìŠµ, ê²€ì¦, ì˜ˆì¸¡, ì‹œê°í™”
for level in ['Low', 'Mid', 'High']:
    # 1) í•´ë‹¹ ê·¸ë£¹ ë°ì´í„° ë¶„ë¦¬
    df_lvl = df[df['price_level'] == level].copy()
    X = df_lvl[features]
    y = df_lvl[target]
    
    # 2) hold-out test set ìƒì„± (20%)
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.2, random_state=42
    )
    
    # 3) RidgeCV ëª¨ë¸ í•™ìŠµ (ë‚´ë¶€ 5-fold CV í¬í•¨)
    # ElasticNetê³¼ ë‹¬ë¦¬ RidgeëŠ” l1_ratioê°€ ì—†ê³  alphaë§Œ íŠœë‹í•©ë‹ˆë‹¤
    ridge = RidgeCV(
        alphas=np.logspace(-4, 1, 10),  # ë‹¤ì–‘í•œ alpha ê°’ ê²€ì‚¬ (10ê°œ) ê³¼ì í•©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ í˜ë„í‹° ë¶€ì—¬ í´ìˆ˜ë¡ ê·œì œ ê°•í•˜ê²Œ
        cv=5,                           # 5-fold êµì°¨ê²€ì¦ 5ë²ˆ ê³¼ì í•© ë°©ì§€ í•œë²ˆë§Œí•˜ë©´ ì¼ë°˜ì ì¸ íŒ¨í„´ íŒŒì•… ëª»í•˜ê³  í›ˆë ¨ ë°ì´í„°ë§Œ ì í•©í•œ ê²°ê³¼ë¥¼ ë§Œë“¤ê¸° ë•Œë¬¸
        scoring='neg_mean_squared_error' # MSEë¥¼ ìµœì†Œí™”í•˜ëŠ” alpha ì„ íƒ
    )
    ridge.fit(X_train, y_train)
    
    # 4) Test set ì„±ëŠ¥ í‰ê°€ ëª¨ë¸ì˜ ì¼ë°˜í™” ëŠ¥ë ¥ í‰ê°€ë¥¼ ìœ„í•œtest set 
    y_test_pred = ridge.predict(X_test) # ridgeëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì˜ˆì¸¡ ìˆ˜í–‰
    r2   = r2_score(y_test, y_test_pred) # ëª¨ë¸ì´ ì‹¤ì œ ë°ì´í„° ë¶„ì‚°ì„ ì–¼ë§ˆë‚˜ ì˜ ì„¤ëª…í•˜ëŠ”ì§€ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ
    rmse = np.sqrt(mean_squared_error(y_test, y_test_pred))
    
    
    # ëª¨ë¸ì˜ ê³„ìˆ˜ í™•ì¸ (RidgeëŠ” ëª¨ë“  ë³€ìˆ˜ì˜ ê³„ìˆ˜ë¥¼ ìœ ì§€í•¨)
    coefficients = pd.DataFrame({
        'Feature': features,
        'Coefficient': ridge.coef_
    }).sort_values('Coefficient', ascending=False)

    
    # 5) ì „ì²´ ê·¸ë£¹ ë°ì´í„°ì— ëŒ€í•´ ì˜ˆì¸¡ ë° residual ê³„ì‚°
    df_lvl['predicted'] = ridge.predict(X)
    df_lvl['residual']  = df_lvl['SalePrice'] - df_lvl['predicted']
    
    # 6) ì´ìƒì¹˜(í—ˆìœ„ë§¤ë¬¼) í”Œë˜ê·¸: residual í•˜ìœ„ 25% ì´í•˜ë©´ True
    thresh = df_lvl['residual'].quantile(72/2579) # ìš°ë¦¬ê°€ ì „ì²´ ëŒ€ë¹„ ì ìˆ˜ì œë¡œ ë½‘ì€ ë§¤ë¬¼í›„ë³´ ìˆ˜ì˜ë¹„ìœ¨ë¡œ í™•ì¸ 
    df_lvl['ridge_flag'] = df_lvl['residual'] <= thresh
    
    # 7) ì¸í„°ë™í‹°ë¸Œ ì‚°ì ë„
    fig = px.scatter(
        df_lvl,
        x='SalePrice',
        y='predicted',
        color='ridge_flag',
        color_discrete_map={True: 'red', False: 'lightgray'},
        title=f'Actual vs. Predicted ({level}) - Ridge Regression',
        labels={'SalePrice':'ì‹¤ì œê°€ê²©','predicted':'ì˜ˆì¸¡ê°€ê²©','ridge_flag':'í—ˆìœ„ë§¤ë¬¼ ì˜ì‹¬'},
        opacity=0.7
    )

# (1) ì‚¬ìš©í•  í”¼ì²˜Â·íƒ€ê²Ÿ ì¬í™•ì¸
features = ['OverallQual', 'OverallCond', 'GrLivArea', 'YearRemodAdd', 'RoomDensity', 'amenities']
target   = 'SalePrice'

# (2) í”Œë˜ê·¸ ì»¬ëŸ¼ ì´ˆê¸°í™”
df['elastic_flag'] = False
df['ridge_flag']   = False

# (3) RidgeCVë¡œ ì „ì²´ ë°ì´í„°ì— ëŒ€í•´ í”Œë˜ê·¸ ê³„ì‚°
for level in ['Low','Mid','High']:
    mask = df['price_level']==level
    X = df.loc[mask, features]
    y = df.loc[mask, target]
    ridge = RidgeCV(
        alphas=np.logspace(-4, 1, 10),
        cv=5,
        scoring='neg_mean_squared_error'
    )
    ridge.fit(X, y)
    preds = ridge.predict(X)
    resid = y - preds
    thresh = resid.quantile(72/2579)
    df.loc[mask, 'ridge_flag'] = resid <= thresh

# (4) ì¸ë±ìŠ¤ ì§‘í•©ìœ¼ë¡œ ë³€í™˜
score_set   = set(df.index[df['suspect_flag']])
ridge_set   = set(df.index[df['ridge_flag']])

```

# 5. ê²°ë¡ 

## Row

```{python}
#| content: valuebox
#| title: "ì ìˆ˜ì œ í—ˆìœ„ë§¤ë¬¼"
#| icon: house
#| color: "#FFD700"
dict(
  value = "72ê°œ",
  )
```

```{python}
#| content: valuebox
#| title: "íšŒê·€ë¶„ì„ í—ˆìœ„ë§¤ë¬¼"
#| icon: house
#| color: "#FFD700"
dict(
  value = "73ê°œ",
  )
```

```{python}
#| content: valuebox
#| title: "ìµœì¢… ì„ ì • í—ˆìœ„ë§¤ë¬¼"
#| icon: exclamation-triangle
#| color: "#FF0000"
dict(
  value = "8ê°œ",
  style = "font-size: 10px;"
  )
```

::: {.column width="50%"}
## Row {.tabset}

### ì ìˆ˜ì œ

```{python}
import folium
common_df2 = df.loc[list(score_set)]
# ì¢Œí‘œ ê²°ì¸¡ì¹˜ ì œê±°
common_df2_1 = common_df2.dropna(subset=["Latitude", "Longitude"])

# ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ì„¤ì •
center_lat = common_df2_1["Latitude"].mean()
center_lon = common_df2_1["Longitude"].mean()

# folium ì§€ë„ ê°ì²´ ìƒì„±
fig7 = folium.Map(location=[center_lat, center_lon], zoom_start=12)

# price_levelë³„ ìƒ‰ìƒ ì§€ì •
color_map = {
    'Low': 'blue',
    'Mid': 'green',
    'High': 'red'
}

# ë§ˆì»¤ ì¶”ê°€ (ìë™ ì¶œë ¥ ì–µì œ)
for _, row in common_df2_1.iterrows():
    popup_text = f"""
    <b>ì§€ì—­:</b> {row['Neighborhood']}<br>
    <b>ë§¤ë§¤ê°€:</b> ${row['SalePrice']:,}<br>
    <b>ì§€ìƒë©´ì :</b> {row['GrLivArea']} sqft<br>
    <b>ë§ˆê° í’ˆì§ˆ:</b> {row['OverallQual']}<br>
    <b>ì „ë°˜ ìƒíƒœ:</b> {row['OverallCond']}<br>
    <b>í¸ì˜ì‹œì„¤ ìˆ˜:</b> {row['amenities']}<br>
    <b>ë¦¬ëª¨ë¸ë§ ì—°ë„:</b> {row['YearRemodAdd']}<br>
    <b>ì ìˆ˜ì œ ì ìˆ˜:</b> {row['score']}
    """
    _ = folium.Marker(
        location=[row['Latitude'], row['Longitude']],
        popup=folium.Popup(popup_text, max_width=250),
        icon=folium.Icon(
            color=color_map.get(row['price_level'], 'gray'),
            icon='exclamation-sign',
            prefix='glyphicon'
        )
    ).add_to(fig7)

# ì§€ë„ ì¶œë ¥
fig7
```

### íšŒê·€ë¶„ì„

```{python}
import folium
common_df3 = df.loc[list(ridge_set)]
# ì¢Œí‘œ ê²°ì¸¡ì¹˜ ì œê±°
common_df3_1 = common_df3.dropna(subset=["Latitude", "Longitude"])

# ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ì„¤ì •
center_lat = common_df3_1["Latitude"].mean()
center_lon = common_df3_1["Longitude"].mean()

# folium ì§€ë„ ê°ì²´ ìƒì„±
fig8 = folium.Map(location=[center_lat, center_lon], zoom_start=12)

# price_levelë³„ ìƒ‰ìƒ ì§€ì •
color_map = {
    'Low': 'blue',
    'Mid': 'green',
    'High': 'red'
}

# ë§ˆì»¤ ì¶”ê°€ (ìë™ ì¶œë ¥ ì–µì œ)
for _, row in common_df3_1.iterrows():
    popup_text = f"""
    <b>ì§€ì—­:</b> {row['Neighborhood']}<br>
    <b>ë§¤ë§¤ê°€:</b> ${row['SalePrice']:,}<br>
    <b>ì§€ìƒë©´ì :</b> {row['GrLivArea']} sqft<br>
    <b>ë§ˆê° í’ˆì§ˆ:</b> {row['OverallQual']}<br>
    <b>ì „ë°˜ ìƒíƒœ:</b> {row['OverallCond']}<br>
    <b>í¸ì˜ì‹œì„¤ ìˆ˜:</b> {row['amenities']}<br>
    <b>ë¦¬ëª¨ë¸ë§ ì—°ë„:</b> {row['YearRemodAdd']}<br>
    <b>ì ìˆ˜ì œ ì ìˆ˜:</b> {row['score']}
    """
    _ = folium.Marker(
        location=[row['Latitude'], row['Longitude']],
        popup=folium.Popup(popup_text, max_width=250),
        icon=folium.Icon(
            color=color_map.get(row['price_level'], 'gray'),
            icon='exclamation-sign',
            prefix='glyphicon'
        )
    ).add_to(fig8)

# ì§€ë„ ì¶œë ¥
fig8
```

### ê³µí†µí—ˆìœ„ë§¤ë¬¼

```{python}

import folium
from IPython.display import display

# ê³µí†µ í—ˆìœ„ë§¤ë¬¼ë§Œ ì¶”ì¶œ (ì ìˆ˜ì œ + Ridge íšŒê·€ ëª¨ë‘ í•´ë‹¹)
common_df = df.loc[list(score_set & ridge_set)].copy()

# ì¢Œí‘œ ê²°ì¸¡ì¹˜ ì œê±°
common_df1 = common_df.dropna(subset=["Latitude", "Longitude"])

# ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ì„¤ì •
center_lat = common_df1["Latitude"].mean()
center_lon = common_df1["Longitude"].mean()

# folium ì§€ë„ ê°ì²´ ìƒì„±
fig6 = folium.Map(location=[center_lat, center_lon], zoom_start=12)

# price_levelë³„ ìƒ‰ìƒ ì§€ì •
color_map = {
    'Low': 'blue',
    'Mid': 'green',
    'High': 'red'
}

# ë§ˆì»¤ ì¶”ê°€
for _, row in common_df1.iterrows():
    popup_text = f"""
    <b>ì§€ì—­:</b> {row['Neighborhood']}<br>
    <b>ë§¤ë§¤ê°€:</b> ${row['SalePrice']:,}<br>
    <b>ì§€ìƒë©´ì :</b> {row['GrLivArea']} sqft<br>
    <b>ë§ˆê° í’ˆì§ˆ:</b> {row['OverallQual']}<br>
    <b>ì „ë°˜ ìƒíƒœ:</b> {row['OverallCond']}<br>
    <b>í¸ì˜ì‹œì„¤ ìˆ˜:</b> {row['amenities']}<br>
    <b>ë¦¬ëª¨ë¸ë§ ì—°ë„:</b> {row['YearRemodAdd']}<br>
    <b>ì ìˆ˜ì œ ì ìˆ˜:</b> {row['score']}
    """
    _ = folium.Marker(
        location=[row['Latitude'], row['Longitude']],
        popup=folium.Popup(popup_text, max_width=250),
        icon=folium.Icon(
            color=color_map.get(row['price_level'], 'gray'),
            icon='exclamation-sign',
            prefix='glyphicon'
        )
    ).add_to(fig6)

# ì§€ë„ ì¶œë ¥
display(fig6)
```
:::

```{python}
cols = [
    'Neighborhood','PID', 'SalePrice', 'score',
    'OverallQual', 'OverallCond', 'GrLivArea',
    'YearRemodAdd', 'RoomDensity', 'amenities',
]
common_df_selected = common_df[cols]
common_df_selected.sort_values(by='Neighborhood')

```

ğŸ“ ì„œë¡œ ë‹¤ë¥¸ íƒì§€ ê´€ì ì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ë‘ê°€ì§€ ë°©ë²•ì˜ ê²°ê³¼ê°€ ìƒì´í•˜ë‹¤ê³  íŒë‹¨

## Row {width="100%"}

::: {style="border: 2px solid #DC143C; border-radius: 10px; padding: 15px; background-color: #fff5f5;"}
[ ğŸ  ìµœì¢… ê²°ë¡  ]{style="font-size: 20px; font-weight: bold; color: #DC143C;"}<br><br> ì ìˆ˜ì œë¥¼ í†µí•œ í—ˆìœ„ë§¤ë¬¼ íƒì§€ëŠ” <b>ì§ê´€ì ì¸</b> ê¸°ì¤€ì— ê¸°ë°˜í•´ ë¹ ë¥´ê²Œ ì˜ì‹¬ ë§¤ë¬¼ì„ ê±¸ëŸ¬ë‚¼ ìˆ˜ ìˆìœ¼ë©°,<br> íšŒê·€ ë¶„ì„ì„ í†µí•œ ë°©ë²•ì€ <b>íŒ¨í„´ë¶„ì„</b>ì„ í†µí•´ <b>ì •êµí•œ íŒë‹¨</b>ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>

ë‘ ê°€ì§€ ë°©ë²•ì„ <b style="color:#DC143C;">ë³´ì™„ì ìœ¼ë¡œ í•¨ê»˜ í™œìš©</b>í•  ê²½ìš°,<br> ë‹¨ì¼ ë°©ë²•ë³´ë‹¤ <b>ë” ë†’ì€ ì‹ ë¢°ë„ë¡œ í—ˆìœ„ë§¤ë¬¼ ê°€ëŠ¥ì„±ì´ ë†’ì€ ëŒ€ìƒ</b>ì„ ì„ ë³„í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨ë©ë‹ˆë‹¤.
:::